define("model/model.js",["base/base","base/event","common/funs","storage/store"],function(require,t,e){function s(){}function i(t,e,s,r){if(!t.v){var a=this,o=function(){setTimeout(function(){t.v||i.call(a,t,e,s,r)},1e3*e)};this.request({success:function(){s.success&&s.success.apply(this,arguments),o()},error:function(){s.error&&s.error.apply(this,arguments),o()},abort:function(){s.abort&&s.abort.apply(this,arguments),o()}},r)}}var r=require("base/base"),a=require("base/event"),o=require("common/funs"),n=require("storage/store"),h=0,u=1,c=2,l=function(){this.off("success"),this.off("error"),this.off("abort")},f=/\{[^\{\}]*\}/,p=a.extend({propertys:function(){this._xhr,this.type="post",this.getfields=[],this.pathfields=[],this.param=this.buildParam(),this.result=this.buildResult(),this.state=h},initialize:function(){},setType:function(t){this.type=t},fieldsGet:function(){return[]},buildBaseUrl:function(){throw"Please override the `buildBaseUrl` method"},buildUrl:function(){throw"Please override the `buildUrl` method"},buildParam:function(){throw"Please override the `buildParam` method"},buildResult:function(){throw"Please override the `buildResult` method"},ajaxRequest:function(){throw"Please override the `ajaxRequest(type,url)` method"},verifyData:function(t){return!0},getParam:function(t){return this.param instanceof n?t?this.param.getAttr(t):this.param.get():JSON.parse(JSON.stringify(this.param))},setParam:function(t,e){return"object"===r.type(t)?void r.each(t,function(t,e){this.setParam(e,t)},this):void(this.param instanceof n?this.param.setAttr(t,e):(this.param||(this.param={}),this.param[t]=e))},delParam:function(t){return"array"===r.type(t)?void r.each(t,function(t){this.delParam(t)},this):void(this.param instanceof n?this.param.delAttr(t):(this.param||(this.param={}),delete this.param[k]))},getResult:function(){if(this.result instanceof n){var t=this.getParam(),e=t?JSON.stringify(t):null;return this.result.get(e)}return this.result},setResult:function(t){if(this.result instanceof n){var e=this.getParam(),s=e?JSON.stringify(e):null;this.result.set(t,s)}},request:function(t,e){t=t||{};var i,a=t.success||s,n=t.error||s,p=t.abort||s;if(this.state===c){if(i=this.getResult())return void a.call(e||this,i);this.state=h}if(this.state==c||(this.on("success",a,e),this.on("error",n,e),this.on("abort",p,e),this.state!==u)){this.baseurl=this.buildBaseUrl(),this.url=this.buildUrl();var m=this.baseurl.replace(/\/+$/g,"")+"/"+this.url.replace(/^\/+/g,""),d=this.getParam()||{},b=this,v=[];if(this.type&&!this.type.match(/get/i)){var g=m.indexOf("?")>-1?"&":"?",y=function(t,e){var s=[];return"*"===t?r.each(e,function(t,e){s.push(e+"="+t)}):r.each(t,function(t){e[t]&&s.push(t+"="+e[t])}),s.join("&")}(this.fieldsGet(),d);y&&(m=(m+g+y).replace(/\?{2,}/i,"?").replace(/\?&+/i,"?"))}return m.match(f)&&(m=o.formatString(m,d||{},function(t){v.push(t)}),r.each(v,function(t){delete d[t]})),this.isAbort=!1,this.state=u,this._xhr=this.ajaxRequest(this.type,m,d,function(t){b.verifyData(t)?(b.setResult(t),b.emit("success",t),b.state=c):(b.emit("error",t),b.state=h),l.call(b),this.isAbort=!1},function(t){this.isAbort?b.emit("abort",t):b.emit("error",t),b.state=h,l.call(b),this.isAbort=!1}),this._xhr}},abort:function(){this._xhr&&(this.isAbort=!0,this._xhr.abort())},isLoopStop:{v:!1},loopRequest:function(t,e,s){this.isLoopStop.v=!0,this.isLoopStop={v:!1},i.call(this,this.isLoopStop,t,e,s)},endLoopRequest:function(){this.isLoopStop.v=!0,this._xhr&&this._xhr.abort()}});return p});