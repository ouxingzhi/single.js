define("SINGLE/model/model.js",["SINGLE/base/base","SINGLE/base/event","SINGLE/common/funs","SINGLE/storage/store"],function(require,t,e){function s(){}function i(t,e,s,r){if(!t.v){var a=this,o=function(){setTimeout(function(){t.v||i.call(a,t,e,s,r)},1e3*e)};this.request({success:function(){s.success&&s.success.apply(this,arguments)},error:function(){s.error&&s.error.apply(this,arguments)},abort:function(){s.abort&&s.abort.apply(this,arguments)},complete:function(){s.complete&&s.complete.apply(this,arguments),o()}},r)}}var r=require("SINGLE/base/base"),a=require("SINGLE/base/event"),o=require("SINGLE/common/funs"),h=require("SINGLE/storage/store"),n=0,u=1,c=2,l=function(){this.off("success"),this.off("error"),this.off("abort"),this.off("complete")},f=/\{[^\{\}]*\}/,p=a.extend({propertys:function(){this._xhr,this.type="post",this.getfields=[],this.pathfields=[],this.param=this.buildParam(),this.result=this.buildResult(),this.state=n},initialize:function(){},setType:function(t){this.type=t},fieldsGet:function(){return[]},buildBaseUrl:function(){throw"Please override the `buildBaseUrl` method"},buildUrl:function(){throw"Please override the `buildUrl` method"},buildParam:function(){throw"Please override the `buildParam` method"},buildResult:function(){throw"Please override the `buildResult` method"},ajaxRequest:function(){throw"Please override the `ajaxRequest(type,url)` method"},verifyData:function(t){return!0},getParam:function(t){return this.param instanceof h?t?this.param.getAttr(t):this.param.get():JSON.parse(JSON.stringify(this.param))},setParam:function(t,e){return"object"===r.type(t)?void r.each(t,function(t,e){this.setParam(e,t)},this):void(this.param instanceof h?this.param.setAttr(t,e):(this.param||(this.param={}),this.param[t]=e))},delParam:function(t){return"array"===r.type(t)?void r.each(t,function(t){this.delParam(t)},this):void(this.param instanceof h?this.param.delAttr(t):(this.param||(this.param={}),delete this.param[k]))},getResult:function(){if(this.result instanceof h){var t=this.getParam(),e=t?JSON.stringify(t):null;return this.result.get(e)}return this.result},setResult:function(t){if(this.result instanceof h){var e=this.getParam(),s=e?JSON.stringify(e):null;this.result.set(t,s)}},request:function(t,e){t=t||{};var i,a=t.success||s,h=t.error||s,p=t.abort||s,m=t.complete||s;if(this.state===c){if(i=this.getResult())return void a.call(e||this,i);this.state=n}if(this.state==c||(this.on("success",a,e),this.on("error",h,e),this.on("abort",p,e),this.on("complete",m,e),this.state!==u)){this.baseurl=this.buildBaseUrl(),this.url=this.buildUrl();var d=this.baseurl.replace(/\/+$/g,"")+"/"+this.url.replace(/^\/+/g,""),b=this.getParam()||{},v=this,x=[];if(this.type&&!this.type.match(/get/i)){var g=d.indexOf("?")>-1?"&":"?",y=function(t,e){var s=[];return"*"===t?r.each(e,function(t,e){s.push(e+"="+t)}):r.each(t,function(t){e[t]&&s.push(t+"="+e[t])}),s.join("&")}(this.fieldsGet(),b);y&&(d=(d+g+y).replace(/\?{2,}/i,"?").replace(/\?&+/i,"?"))}d.match(f)&&(d=o.formatString(d,b||{},function(t){x.push(t)}),r.each(x,function(t){delete b[t]})),this.isAbort=!1,this.state=u;var S=this;return this._xhr=this.ajaxRequest(this.type,d,b,function(t){v.verifyData(t)?(v.setResult(t),v.emit("success",t,S._xhr.status,S._xhr),v.state=c):(v.emit("error",t,S._xhr.status,S._xhr),v.state=n),v.emit("complete",S._xhr.status,S._xhr),l.call(v),this.isAbort=!1},function(t){this.isAbort?v.emit("abort",t,S._xhr.status,S._xhr):v.emit("error",t,S._xhr.status,S._xhr),v.emit("complete",S._xhr.status,S._xhr),v.state=n,l.call(v),this.isAbort=!1}),this._xhr}},abort:function(){this._xhr&&(this.isAbort=!0,this._xhr.abort())},isLoopStop:{v:!1},loopRequest:function(t,e,s){"object"==typeof t&&(s=e,e=t,t=5),this.isLoopStop.v=!0,this.isLoopStop={v:!1},i.call(this,this.isLoopStop,t,e,s)},endLoopRequest:function(){this.isLoopStop.v=!0,this._xhr&&this._xhr.abort()}});return p});