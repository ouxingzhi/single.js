define("SINGLE/mvc/history.js",["SINGLE/base/base","SINGLE/base/object"],function(require,t,e){function r(t,e,r){var i=t.url||"",e=_.extend(_.clone(t.params||{}),e||{});if(i=i.replace(c,function(t,r){return e[r]?e[r]:""}),t.querys){var n=$.param(_.extend(_.clone(t.querys||{}),r||{}));n&&(i+=i.indexOf("?")>-1?"&"+n:"?"+n)}return i}var i=require("SINGLE/base/base"),n=require("SINGLE/base/object"),o=n.extend({propertys:function(){this.store},initialize:function($super,t){$super(),this.store=t},forward:function(t,e,r){this.store.setAttr("cached",{id:t,url:e,replace:!!r})},affirm:function(t){var e=this.store.getAttr("cached");if(this.store.setAttr("cached",{}),!e||e.id!=t)return!1;var r=this.getTop();if(r&&r.id===t)return!1;var i=this.store.getAttr("stack")||[];i.replace&&i.pop(),i.push(e),this.store.setAttr("stack",i)},back:function(t){var e=this.getTop()||{};if(e.id==t)return this.popTop(),this.getTop()},getCached:function(){return this.store.getAttr("cached")},getTop:function(){var t=this.store.getAttr("stack")||[];return t.length?t[Math.max(t.length-1,0)]:null},popTop:function(){var t=this.store.getAttr("stack")||[],e=t.pop();return this.store.setAttr("stack",t),e},fallback:function(t){var e,r=this.store.getAttr("stack")||[],n=-1;return i.each(r,function(e,r){return e.id===t?(n=r,!0):void 0},null,!0),n>-1&&(e=r.splice(n)),e},clear:function(){this.store.remove()}}),s=n.extend({propertys:function(){},initialize:function($super,t){var e={};i.each(t,function(t,r){e[t.id]=t}),this.tree=e},getNode:function(t){return this.tree[t]},getPrevNode:function(t){var e=this.getNode(t);if(e)return this.getNode(e.prev)},getPrevUrl:function(t,e,i){var n=this.getPrevNode(t);return n?r(n,e,i):null},checkPrevRange:function(t,e){var r=this.getNode(t);return r&&r.prevRange?r.prevRange.indexOf(e)>-1?!0:!1:!0}}),c=/\{([^\{\}]*)\}/gim;return n.extend({initialize:function($super){this.stack=new o(this.buildStackStore()),this.tree=new s(this.buildTreeConfig())},buildTreeConfig:function(){throw"not override `buildTreeConfig` method"},buildStackStore:function(){throw"not override `buildStackStore` method"},forward:function(t,e){this.stack.forward(t,e)},affirm:function(t){this.stack.affirm(t)},replace:function(t,e){this.stack.forward(t,e,!0)},back:function(t,e,r){{var i=this.stack.back(t);this.tree.getNode(t)}return i&&this.tree.checkPrevRange(t,i.id)?i.url:this.tree.getPrevUrl(t,e,r)},clear:function(){this.stack.clear()}})});